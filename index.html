<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ä¼˜ç±³ç¬”è®° | å®‰å…¨åŠ å¯†äº‘ç¬”è®°</title>
    <link rel="manifest" href="manifest.json">
    <link rel="apple-touch-icon" href="icon.png">
    <meta name="theme-color" content="#020617">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #020617;
            color: #f8fafc;
            /* è§£å†³ç§»åŠ¨ç«¯åº•éƒ¨è¾“å…¥æ¡†è¢«é®æŒ¡é—®é¢˜ */
            padding-bottom: env(safe-area-inset-bottom);
        }

        .glass {
            background: rgba(30, 41, 59, 0.7);
            backdrop-filter: blur(12px);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .gradient-btn {
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .gradient-btn:active {
            transform: scale(0.98);
        }

        .gradient-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            filter: grayscale(100%);
        }

        /* éšè—æ»šåŠ¨æ¡ */
        ::-webkit-scrollbar {
            width: 0px;
        }

        /* Toast åŠ¨ç”» */
        @keyframes slideIn {
            from { transform: translateY(-100%); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }
        .toast-enter {
            animation: slideIn 0.3s ease-out forwards;
        }
    </style>
</head>

<body class="min-h-screen selection:bg-blue-500/30">
    <div id="toastContainer" class="fixed top-4 left-0 right-0 z-[100] flex flex-col items-center gap-2 pointer-events-none"></div>

    <div id="app" class="max-w-3xl mx-auto px-6 py-8 md:py-20 pb-32">
        </div>

    <div id="confirmModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden opacity-0 transition-opacity duration-300">
        <div class="glass w-[90%] max-w-sm p-6 rounded-3xl shadow-2xl transform scale-95 transition-transform duration-300" id="confirmBox">
            <h3 class="text-xl font-bold mb-2">âš ï¸ ç¡®è®¤æ“ä½œ</h3>
            <p id="confirmMsg" class="text-slate-400 text-sm mb-6 leading-relaxed"></p>
            <div class="flex gap-3">
                <button id="confirmCancelBtn" class="flex-1 py-3 text-slate-400 font-semibold rounded-xl hover:bg-slate-800 transition text-sm">å–æ¶ˆ</button>
                <button id="confirmOkBtn" class="flex-1 py-3 gradient-btn text-white font-bold rounded-xl text-sm shadow-lg shadow-blue-900/20">ç¡®è®¤</button>
            </div>
        </div>
    </div>

    <div id="settingsModal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center hidden">
        <div class="glass w-[90%] max-w-sm p-8 rounded-[2.5rem] shadow-2xl space-y-6">
            <h2 class="text-2xl font-extrabold tracking-tight">âš™ï¸ ç³»ç»Ÿé…ç½®</h2>
            <div class="space-y-4">
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">API åœ°å€</label>
                    <input id="setApi" type="text" placeholder="https://..."
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
                <div class="space-y-1">
                    <label class="text-[10px] uppercase tracking-widest text-slate-400 font-bold ml-1">ç®¡ç†å‘˜å¯†é’¥</label>
                    <input id="setKey" type="password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢"
                        class="w-full bg-slate-900/50 border border-slate-700 p-4 rounded-2xl outline-none focus:ring-2 ring-blue-500/50 text-sm transition-all">
                </div>
            </div>
            <div class="flex gap-3">
                <button onclick="closeSettings()" class="flex-1 py-4 text-slate-400 font-semibold rounded-2xl hover:bg-slate-800 transition">å–æ¶ˆ</button>
                <button onclick="saveSettings()" class="flex-1 py-4 gradient-btn text-white font-bold rounded-2xl">ä¿å­˜</button>
            </div>
            <div class="text-center pt-4 border-t border-white/5 mt-4">
                <a href="https://v.kuaishou.com/J4JJLtMH" target="_blank"
                    class="text-[10px] text-slate-500 hover:text-blue-400 font-bold tracking-widest uppercase transition flex items-center justify-center gap-2">
                    <span class="bg-orange-500/20 text-orange-500 px-1.5 py-0.5 rounded text-[9px]">å…³æ³¨</span>
                    å¿«æ‰‹ @è´Ÿå€ºäººæ‰“å·¥æ—¥è®°
                </a>
            </div>
        </div>
    </div>

    <script>
        /* --- 1. æ ¸å¿ƒåŠ å¯†æ¨¡å— (PBKDF2 + AES-GCM + Salt) --- */
        const CryptoModule = {
            // ç”Ÿæˆéšæœºç›
            generateSalt: () => window.crypto.getRandomValues(new Uint8Array(16)),
            
            // æ´¾ç”Ÿå¯†é’¥
            getKeyMaterial: async (password) => {
                const enc = new TextEncoder();
                return window.crypto.subtle.importKey(
                    "raw", enc.encode(password), { name: "PBKDF2" }, false, ["deriveBits", "deriveKey"]
                );
            },
            
            getKey: async (keyMaterial, salt) => {
                return window.crypto.subtle.deriveKey(
                    { "name": "PBKDF2", salt: salt, "iterations": 100000, "hash": "SHA-256" },
                    keyMaterial,
                    { "name": "AES-GCM", "length": 256 },
                    true, ["encrypt", "decrypt"]
                );
            },

            // åŠ å¯†
            encrypt: async (text, password) => {
                try {
                    const salt = CryptoModule.generateSalt();
                    const keyMaterial = await CryptoModule.getKeyMaterial(password);
                    const key = await CryptoModule.getKey(keyMaterial, salt);
                    const iv = window.crypto.getRandomValues(new Uint8Array(12));
                    const enc = new TextEncoder();
                    const encrypted = await window.crypto.subtle.encrypt({ name: "AES-GCM", iv: iv }, key, enc.encode(text));
                    
                    return btoa(JSON.stringify({
                        iv: Array.from(iv),
                        salt: Array.from(salt),
                        data: Array.from(new Uint8Array(encrypted))
                    }));
                } catch (e) {
                    console.error("Encryption failed", e);
                    throw new Error("åŠ å¯†å¤±è´¥");
                }
            },

            // è§£å¯†
            decrypt: async (jsonStr, password) => {
                try {
                    const raw = JSON.parse(atob(jsonStr));
                    // å¼ºåˆ¶æ–°ç‰ˆéªŒè¯
                    if (!raw.salt) throw new Error("Old format");

                    const salt = new Uint8Array(raw.salt);
                    const iv = new Uint8Array(raw.iv);
                    const data = new Uint8Array(raw.data);
                    
                    const keyMaterial = await CryptoModule.getKeyMaterial(password);
                    const key = await CryptoModule.getKey(keyMaterial, salt);
                    
                    const decrypted = await window.crypto.subtle.decrypt({ name: "AES-GCM", iv: iv }, key, data);
                    return new TextDecoder().decode(decrypted);
                } catch (e) {
                    return null; // è§£å¯†å¤±è´¥
                }
            }
        };

        /* --- 2. UI å·¥å…·æ¨¡å— (Toast & Loading) --- */
        const UI = {
            toast: (msg, type = 'info') => {
                const container = document.getElementById('toastContainer');
                const el = document.createElement('div');
                const colors = type === 'error' ? 'bg-red-500/90 text-white' : (type === 'success' ? 'bg-emerald-500/90 text-white' : 'bg-slate-800/90 text-slate-200');
                el.className = `pointer-events-auto px-6 py-3 rounded-full text-sm font-bold shadow-xl backdrop-blur-md toast-enter ${colors}`;
                el.innerText = msg;
                container.appendChild(el);
                setTimeout(() => {
                    el.style.opacity = '0';
                    el.style.transform = 'translateY(-20px)';
                    el.style.transition = 'all 0.3s';
                    setTimeout(() => el.remove(), 300);
                }, 3000);
            },
            
            confirm: (msg) => {
                return new Promise((resolve) => {
                    const modal = document.getElementById('confirmModal');
                    const box = document.getElementById('confirmBox');
                    const msgEl = document.getElementById('confirmMsg');
                    const okBtn = document.getElementById('confirmOkBtn');
                    const cancelBtn = document.getElementById('confirmCancelBtn');

                    msgEl.innerText = msg;
                    modal.classList.remove('hidden');
                    requestAnimationFrame(() => {
                        modal.classList.remove('opacity-0');
                        box.classList.remove('scale-95');
                    });

                    const cleanup = () => {
                        modal.classList.add('opacity-0');
                        box.classList.add('scale-95');
                        setTimeout(() => modal.classList.add('hidden'), 300);
                        okBtn.onclick = null;
                        cancelBtn.onclick = null;
                    };

                    okBtn.onclick = () => { cleanup(); resolve(true); };
                    cancelBtn.onclick = () => { cleanup(); resolve(false); };
                });
            },

            setLoading: (btnId, isLoading, loadingText = "å¤„ç†ä¸­...", normalText) => {
                const btn = typeof btnId === 'string' ? document.getElementById(btnId) : btnId;
                if (!btn) return;
                if (isLoading) {
                    btn.dataset.normalText = btn.innerText; 
                    btn.innerText = loadingText;
                    btn.disabled = true;
                } else {
                    btn.innerText = normalText || btn.dataset.normalText || "ç¡®è®¤";
                    btn.disabled = false;
                }
            }
        };

        /* --- 3. ä¸šåŠ¡é€»è¾‘ --- */
        let API_URL = localStorage.getItem('cf_notes_api') || "";
        let ADMIN_KEY = localStorage.getItem('cf_notes_key') || "";
        const urlParams = new URLSearchParams(window.location.search);
        const shareId = urlParams.get('share');

        const app = document.getElementById('app');

        function init() {
            if (shareId) renderShareView();
            else if (!API_URL) renderWelcomeView();
            else renderMainView();
        }

        function renderWelcomeView() {
            app.innerHTML = `
            <div class="glass p-12 rounded-[3rem] text-center space-y-8 animate-in fade-in zoom-in duration-700">
                <div class="inline-flex p-5 bg-blue-500/10 rounded-full text-5xl">ğŸ›¡ï¸</div>
                <div class="space-y-2">
                    <h1 class="text-4xl font-extrabold tracking-tight italic">CloudNotes</h1>
                    <p class="text-slate-400 leading-relaxed text-sm">æ‚¨çš„ä¸“å±åˆ†å¸ƒå¼åŠ å¯†ç¬”è®°ç³»ç»Ÿ<br>å®‰å…¨ Â· ç§å¯† Â· æé€Ÿ</p>
                </div>
                <button onclick="configUrl()" class="px-10 py-5 gradient-btn text-white font-black rounded-3xl shadow-2xl w-full md:w-auto">åˆå§‹åŒ–é…ç½®</button>
            </div>
        `;
        }

        function renderMainView() {
            app.innerHTML = `
            <div class="space-y-8 animate-in fade-in slide-in-from-bottom-4 duration-700">
                <header class="flex justify-between items-center">
                    <div class="space-y-1">
                        <h1 class="text-3xl md:text-4xl font-extrabold tracking-tighter bg-gradient-to-r from-white to-slate-500 bg-clip-text text-transparent">ä¼˜ç±³ç¬”è®°</h1>
                    </div>
                    <button onclick="configUrl()" class="p-3 glass rounded-xl hover:bg-slate-800 transition text-lg">âš™ï¸</button>
                </header>

                <main class="glass p-6 md:p-8 rounded-[2rem] shadow-2xl space-y-4 border-white/5">
                    <input id="mainPw" type="password" placeholder="è¾“å…¥ä¸»å¯†ç  (Passkey)" 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-xl outline-none focus:ring-2 ring-blue-500/50 transition-all font-mono text-sm">
                    
                    <textarea id="noteInput" placeholder="å†™ç‚¹ä»€ä¹ˆ..." 
                        class="w-full bg-slate-950/50 border border-slate-800 p-4 h-40 md:h-48 rounded-xl outline-none focus:bg-slate-950 transition-all resize-none leading-relaxed text-base"></textarea>
                    
                    <div class="grid grid-cols-2 gap-3">
                        <button id="btnSave" onclick="doSave()" class="gradient-btn text-white py-4 rounded-xl font-black tracking-widest uppercase text-xs shadow-lg shadow-blue-900/20">åŠ å¯†ä¿å­˜</button>
                        <button id="btnAI" onclick="doAI()" class="glass text-purple-400 py-4 rounded-xl font-black tracking-widest uppercase text-xs hover:bg-purple-500/10 transition border-purple-500/20">âœ¨ AI æ€»ç»“</button>
                    </div>
                </main>

                <section class="space-y-4">
                    <div class="flex justify-between items-center px-2">
                        <h2 class="text-xs font-black uppercase tracking-[0.2em] text-slate-500 italic">Vault</h2>
                        <button id="btnRefresh" onclick="loadList()" class="text-blue-500 text-xs font-black hover:text-blue-400 uppercase flex items-center gap-1">
                           ğŸ”„ åˆ·æ–°åˆ—è¡¨
                        </button>
                    </div>
                    <div id="notesList" class="space-y-3 pb-20">
                        <div class="text-center py-10 text-slate-600 italic text-xs">è¾“å…¥å¯†ç åç‚¹å‡»åˆ·æ–°åŠ è½½æ•°æ®</div>
                    </div>
                </section>
                
                <footer class="text-center pt-8 opacity-60 hover:opacity-100 transition duration-500">
                     <a href="https://v.kuaishou.com/K13u2RPy" target="_blank" class="text-[10px] text-slate-600 font-bold hover:text-orange-500 uppercase tracking-widest transition flex flex-col gap-1 items-center">
                        <span>Built by è´Ÿå€ºäººæ‰“å·¥äººæ—¥è®°</span>
                        <span class="text-[9px] bg-slate-800 px-2 py-0.5 rounded-full text-slate-400">ç‚¹å‡»å…³æ³¨å¿«æ‰‹</span>
                     </a>
                </footer>
            </div>
        `;
        }

        function renderShareView() {
            app.innerHTML = `
            <div class="glass p-8 md:p-12 rounded-[2.5rem] shadow-2xl text-center space-y-8 animate-in zoom-in duration-500 mt-10">
                <div class="text-5xl animate-bounce">ğŸ”¥</div>
                <div class="space-y-2">
                    <h1 class="text-2xl font-black italic">é˜…åå³ç„š</h1>
                    <p class="text-slate-400 text-xs">è§£å¯†åæ•°æ®å°†ç«‹å³ä»æœåŠ¡å™¨æ°¸ä¹…ç‰©ç†æ“¦é™¤</p>
                </div>
                <input id="sharePw" type="password" placeholder="è¯·è¾“å…¥è§£å¯†å¯†ç " class="w-full bg-slate-950/50 border border-slate-800 p-4 rounded-xl outline-none focus:ring-2 ring-orange-500/50 text-center font-mono text-sm">
                <button id="unlockBtn" onclick="doUnlockShare()" class="w-full bg-gradient-to-r from-orange-600 to-red-600 text-white py-4 rounded-xl font-black uppercase tracking-widest shadow-xl hover:scale-[1.02] transition text-sm">è§£å¯†å¹¶é”€æ¯</button>
                <div id="shareResult" class="mt-6 text-left p-5 bg-slate-950/80 rounded-xl hidden whitespace-pre-wrap text-sm leading-relaxed border border-orange-500/20 text-slate-200 select-text"></div>
                
                <div class="pt-8 border-t border-white/5 mt-6">
                    <a href="https://v.kuaishou.com/K13u2RPy" target="_blank" class="text-xs font-black uppercase tracking-widest text-slate-500 hover:text-orange-500 transition flex flex-col gap-1">
                        <span>ğŸ¬ å…³æ³¨å¿«æ‰‹å­¦ä¹ æ­å»º</span>
                        <span class="text-[10px] opacity-70">@è´Ÿå€ºäººæ‰“å·¥æ—¥è®°</span>
                    </a>
                </div>
            </div>
        `;
        }

        /* --- äº¤äº’é€»è¾‘ --- */
        function configUrl() {
            document.getElementById('settingsModal').classList.remove('hidden');
            document.getElementById('setApi').value = API_URL;
            document.getElementById('setKey').value = ADMIN_KEY;
        }
        function closeSettings() { document.getElementById('settingsModal').classList.add('hidden'); }
        function saveSettings() {
            localStorage.setItem('cf_notes_api', document.getElementById('setApi').value);
            localStorage.setItem('cf_notes_key', document.getElementById('setKey').value);
            location.reload();
        }

        async function doSave() {
            const text = document.getElementById('noteInput').value;
            const pw = document.getElementById('mainPw').value;
            if (!text) return UI.toast("å†…å®¹ä¸èƒ½ä¸ºç©º", "error");
            if (!pw) return UI.toast("è¯·è®¾ç½®ä¸»å¯†ç ", "error");

            UI.setLoading("btnSave", true, "åŠ å¯†ä¸Šä¼ ä¸­...");

            try {
                const cipher = await CryptoModule.encrypt(text, pw);
                const res = await fetch(`${API_URL}/api/save`, {
                    method: 'POST', 
                    headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher })
                });
                
                if (res.ok) { 
                    UI.toast("âœ… å·²åŠ å¯†å­˜å…¥äº‘ç«¯", "success");
                    document.getElementById('noteInput').value = "";
                    loadList();
                } else {
                    UI.toast("âŒ ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥å¯†é’¥æˆ–ç½‘ç»œ", "error");
                }
            } catch (e) {
                console.error(e);
                UI.toast("âŒ ç½‘ç»œè¿æ¥å¤±è´¥", "error");
            } finally {
                UI.setLoading("btnSave", false);
            }
        }

        async function loadList() {
            const pw = document.getElementById('mainPw').value;
            if (!pw) return UI.toast("è¯·è¾“å…¥ä¸»å¯†ç ä»¥è§£å¯†", "info");
            
            const btnRefresh = document.getElementById('btnRefresh');
            const originalText = btnRefresh.innerHTML;
            btnRefresh.innerHTML = "â³ åŠ è½½ä¸­...";
            btnRefresh.disabled = true;

            const listDiv = document.getElementById('notesList');
            
            try {
                const res = await fetch(`${API_URL}/api/list`, { headers: { 'Authorization': ADMIN_KEY } });
                if (!res.ok) throw new Error("API Error");
                
                const notes = await res.json();
                listDiv.innerHTML = "";
                
                if (notes.length === 0) {
                    listDiv.innerHTML = '<div class="text-center py-20 text-slate-700 italic text-sm">æš‚æ— æ•°æ®</div>';
                    return;
                }

                notes.sort((a, b) => b.id - a.id);

                for (let n of notes) {
                    const clearText = await CryptoModule.decrypt(n.content, pw);
                    
                    const card = document.createElement('div');
                    card.className = "glass p-5 rounded-2xl space-y-3 border border-white/5 shadow-lg group transition hover:bg-slate-800/50";
                    
                    const metaHtml = `
                        <div class="flex justify-between text-[10px] font-bold text-slate-500 tracking-widest uppercase">
                            <span>#${n.id}</span>
                            <span>${new Date(n.created_at).toLocaleString()}</span>
                        </div>
                    `;
                    
                    const contentDiv = document.createElement('div');
                    contentDiv.className = "text-slate-300 text-sm leading-relaxed whitespace-pre-wrap font-sans break-words";
                    if (clearText) {
                        contentDiv.textContent = clearText; // é˜²XSS
                    } else {
                        contentDiv.innerHTML = `<span class="text-red-400 italic">ğŸ”’ æ— æ³•è§£å¯† (å¯†ç é”™è¯¯æˆ–æ—§ç‰ˆæ•°æ®)</span>`;
                    }

                    const actionsDiv = document.createElement('div');
                    actionsDiv.className = "pt-3 border-t border-white/5 flex flex-wrap gap-4 items-center justify-end opacity-80";
                    actionsDiv.innerHTML = `
                         <button onclick="doShareCopy('${n.content}')" class="text-[10px] font-bold text-blue-400 uppercase tracking-widest hover:text-white transition flex items-center gap-1">ğŸ“¤ åˆ†äº«</button>
                         <button onclick="doExport(${n.id})" class="text-[10px] font-bold text-emerald-500 uppercase tracking-widest hover:text-white transition flex items-center gap-1">ğŸ’¾ å¤‡ä»½</button>
                         <button onclick="doDelete(${n.id})" class="text-[10px] font-bold text-rose-500 uppercase tracking-widest hover:text-white transition flex items-center gap-1 ml-2">ğŸ—‘ï¸ åˆ é™¤</button>
                    `;

                    actionsDiv.children[1].onclick = () => doExportText(clearText, n.id);

                    card.innerHTML = metaHtml;
                    card.appendChild(contentDiv);
                    card.appendChild(actionsDiv);
                    listDiv.appendChild(card);
                }
            } catch (e) {
                console.error(e);
                UI.toast("æ— æ³•æ‹‰å–åˆ—è¡¨ï¼Œè¯·æ£€æŸ¥é…ç½®", "error");
            } finally {
                btnRefresh.innerHTML = originalText;
                btnRefresh.disabled = false;
            }
        }

        async function doShareCopy(cipher) {
            const pid = Math.random().toString(36).substring(2, 12);
            try {
                await fetch(`${API_URL}/api/save`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ content: cipher, public_id: pid, is_share: 1 })
                });
                const fullUrl = `${window.location.origin}${window.location.pathname}?share=${pid}`;
                await navigator.clipboard.writeText(fullUrl);
                UI.toast("ğŸ“‹ é“¾æ¥å·²å¤åˆ¶ï¼é˜…åå³ç„š", "success");
            } catch (e) { 
                prompt("å¤åˆ¶é“¾æ¥:", `${window.location.origin}${window.location.pathname}?share=${pid}`);
            }
        }

        function doExportText(text, id) {
            if (!text) return UI.toast("æ— æ³•å¯¼å‡ºæœªè§£å¯†æ•°æ®", "error");
            const date = new Date().toISOString().split('T')[0];
            const blob = new Blob([text], { type: 'text/plain;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a'); a.href = url; a.download = `Note_${id}_${date}.txt`; a.click();
        }

        async function doDelete(id) {
            const confirmed = await UI.confirm("ç¡®å®šè¦ç‰©ç†æŠ¹é™¤è¿™æ¡è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚");
            if (!confirmed) return;

            try {
                await fetch(`${API_URL}/api/delete`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ id: id })
                });
                UI.toast("ğŸ—‘ï¸ å·²åˆ é™¤", "success");
                loadList();
            } catch (e) {
                UI.toast("åˆ é™¤å¤±è´¥", "error");
            }
        }

        async function doAI() {
            const text = document.getElementById('noteInput').value; 
            if (!text) return UI.toast("è¯·å…ˆè¾“å…¥ç¬”è®°å†…å®¹", "info");
            
            UI.setLoading("btnAI", true, "æ€è€ƒä¸­...");
            try {
                const res = await fetch(`${API_URL}/api/ai-sum`, {
                    method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': ADMIN_KEY },
                    body: JSON.stringify({ text: text.substring(0, 1000) })
                });
                const data = await res.json();
                document.getElementById('noteInput').value += `\n\n--- âœ¨ AI æ€»ç»“ ---\n${data.summary}`;
                UI.toast("AI æ€»ç»“å®Œæˆ", "success");
            } catch(e) {
                UI.toast("AI æœåŠ¡æš‚ä¸å¯ç”¨", "error");
            } finally {
                UI.setLoading("btnAI", false, null, "âœ¨ AI æ€»ç»“");
            }
        }

        async function doUnlockShare() {
            const pw = document.getElementById('sharePw').value;
            if(!pw) return UI.toast("è¯·è¾“å…¥å¯†ç ", "error");

            UI.setLoading("unlockBtn", true, "è§£å¯†ä¸­...");
            const resDiv = document.getElementById('shareResult');
            
            try {
                const res = await fetch(`${API_URL}/api/share/${shareId}`);
                if (!res.ok) throw new Error("å¤±æ•ˆ");
                
                const data = await res.json();
                const clearText = await CryptoModule.decrypt(data.content, pw);
                
                if (clearText) { 
                    resDiv.textContent = clearText;
                    resDiv.classList.remove('hidden'); 
                    const btn = document.getElementById('unlockBtn');
                    btn.innerText = "æ•°æ®å·²ä»æœåŠ¡å™¨é”€æ¯";
                    btn.className = "w-full bg-slate-800 text-slate-500 py-4 rounded-xl font-bold text-sm cursor-not-allowed";
                    btn.disabled = true;
                } else {
                    UI.toast("å¯†ç é”™è¯¯ï¼Œè§£å¯†å¤±è´¥", "error");
                    UI.setLoading("unlockBtn", false, null, "è§£å¯†å¹¶é”€æ¯");
                }
            } catch (e) { 
                UI.toast("é“¾æ¥å·²å¤±æ•ˆæˆ–å·²è¢«ç„šæ¯", "error");
                UI.setLoading("unlockBtn", false, null, "è§£å¯†å¹¶é”€æ¯");
            }
        }

        init();
    </script>
</body>
</html>
